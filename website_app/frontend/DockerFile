# ──────────── Build Stage ────────────
ARG REACT_APP_API_URL            
FROM node:20-slim AS build
WORKDIR /app

# install OS deps (if you have native modules)
RUN apt-get update \
  && apt-get install -y --no-install-recommends python3 build-essential \
  && rm -rf /var/lib/apt/lists/*

# copy package manifests & install
COPY website_app/frontend/package*.json ./
RUN npm ci

# copy source
COPY website_app/frontend/ ./

# bake in your API URL via ENV (CRA/Vite will pick this up)
ENV REACT_APP_API_URL=${REACT_APP_API_URL}

# build the static assets
RUN npm run build      # → produces /app/build

# ──────────── Production Stage ────────────
FROM nginx:alpine
COPY --from=build /app/build /usr/share/nginx/html

# simple SPA + no-api-host fallback
RUN printf '\
  server {                                    \
  listen 80;                                \
  root /usr/share/nginx/html;               \
  index index.html;                         \
  \
  # serve /api by proxying into your backend container \
  location /api/ {                          \
  proxy_pass http://backend:80/api/;      \
  proxy_http_version 1.1;                 \
  proxy_set_header Host $host;            \
  }                                         \
  \
  # all other routes → index.html            \
  location / {                              \
  try_files $uri /index.html;             \
  }                                         \
  }\n' > /etc/nginx/conf.d/default.conf

EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
